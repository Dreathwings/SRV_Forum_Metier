<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableau de bord inscriptions entreprises</title>
  <style>
    :root{--bg:#0b1020; --panel:#121a33; --muted:#8a99b4; --text:#e6ecf7; --accent:#5b9bff; --good:#22c55e; --warn:#f59e0b; --border:#223052; --chip:#1a2447}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0d1430 60%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.2) blur(6px);background:rgba(11,16,32,.75);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:20px;margin:0 0 8px 0}
    .hint{color:var(--muted);font-size:12px}
    button{border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .05s ease,background .2s ease;font-weight:600}
    button:hover{background:#23315d}
    button:active{transform:scale(.98)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .grid{display:grid;gap:12px}
    .stats{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:720px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1024px){.stats{grid-template-columns:repeat(3,1fr);padding:12px}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:800}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-weight:600}
    .chip-dot{width:8px;height:8px;border-radius:50%}
    .chip-aii .chip-dot{background:var(--accent)}
    .chip-ese .chip-dot{background:var(--warn)}
    .chip-eme .chip-dot{background:var(--good)}
    .section-title{margin:24px 0 8px 0;font-size:16px}
    details.group{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--panel)}
    details.group>summary{cursor:pointer;list-style:none;padding:14px 16px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    details.group[open]>summary{border-bottom:1px solid var(--border)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#101733;z-index:1}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
    tr:hover td{background:#0f1a3a}
    .mono{font-variant-numeric:tabular-nums}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0d1b3e;border:1px solid var(--border);font-size:12px}
    .footer{color:var(--muted);font-size:12px;padding:16px 0 40px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Tableau de bord – Inscriptions entreprises</h1>
      <div class="row">
        <button id="btnExport" disabled>Exporter CSV personnes (Nom, Prénom, Poste, Entreprise)</button>
        <button id="btnExportFull" disabled>Exporter CSV Complet (Trier par personnes)</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid stats" id="stats">
      <div class="card kpi"><div class="label">Total Personnes</div><div id="k_total_people" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Total Repas Midi</div><div id="k_lunch_yes" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Total Entreprise</div><div id="k_total_companies" class="value mono">–</div></div>
    </section>
    <section class="grid stats" id="stats">
      <div class="card kpi"><div class="label">Personnes AII</div><div id="k_aii_people" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Personnes ESE</div><div id="k_ese_people" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Personnes EME</div><div id="k_eme_people" class="value mono">–</div></div>
    </section>
    <section class="grid stats" id="stats">
      <div class="card kpi"><div class="label">Entreprises AII</div><div id="k_aii_companies" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Entreprises ESE</div><div id="k_ese_companies" class="value mono">–</div></div>
      <div class="card kpi"><div class="label">Entreprises EME</div><div id="k_eme_companies" class="value mono">–</div></div>
    </section>

    <h2 class="section-title">Entreprises par parcours</h2>
    <div id="groups" class="grid" style="grid-template-columns:1fr; gap:16px"></div>

    <div class="footer">Une entreprise peut apparaître dans plusieurs parcours. Les totaux par parcours ne sont pas exclusifs.</div>
  </main>

  <!-- Flask injecte ici la liste d'objets (ex-lignes CSV) -->
  <script>
    // Exemple: dans votre template Jinja2
    const SERVER_DATA = {{ data | tojson | safe }};
    console.log(SERVER_DATA)
  </script>

  <script>
    const PARCOURS = ["AII","ESE","EME"];
    const el = (s)=>document.querySelector(s);
    const fmt = (n)=>new Intl.NumberFormat('fr-FR').format(n);
    const sanitize = (v)=>v==null?"":String(v).trim();
    const toKey = (s)=>sanitize(s).toLowerCase();

    function parseParcours(raw){
      const s = sanitize(raw).toUpperCase();
      if(!s) return new Set();
      const parts = s.split(/[;,/|]+|\s+\+\s+|\s+/g).map(x=>x.trim()).filter(Boolean);
      const set = new Set();
      for(const p of parts){ if(PARCOURS.includes(p)) set.add(p); }
      return set;
    }
    function isOui(v){
      const s = toKey(v);
      return ["oui","yes","y","1","true"].includes(s);
    }

    function detectPersonIndices(headers){
      const idx = new Set();
      for(const h of headers){
        const s = String(h).toLowerCase();
        let m = s.match(/personne\s*(\d+)\s*nom/);
        if(m){ idx.add(parseInt(m[1],10)); continue; }
        m = s.match(/^p\s*(\d+)[ _-]*nom$/);
        if(m){ idx.add(parseInt(m[1],10)); continue; }
        m = s.match(/^p(\d+)_nom$/);
        if(m){ idx.add(parseInt(m[1],10)); continue; }
      }
      return Array.from(idx).sort((a,b)=>a-b);
    }

        // positions fixes des colonnes
    const COLS = {
      date: 0,
      ent_name: 1,
      ent_addr: 2,
      ent_cp: 3,
      ent_ville: 4,
      ent_desc: 5,
      parcours: 6,
      nb: 7,
      // ensuite blocs de 5 colonnes par personne
      p1_nom: 8,
      p1_prenom: 9,
      p1_email: 10,
      p1_poste: 11,
      p1_dej: 12,
      p2_nom: 13,
      p2_prenom: 14,
      p2_email: 15,
      p2_poste: 16,
      p2_dej: 17,
      p3_nom: 18,
      p3_prenom: 19,
      p3_email: 20,
      p3_poste: 21,
      p3_dej: 22
    };

    function processData(rows){
      let totalPeople=0, lunchYes=0;
      const peoplePerParcours={AII:0,ESE:0,EME:0};
      const companiesPerParcours={AII:0,ESE:0,EME:0};
      const groups={AII:[],ESE:[],EME:[]};
      const companies=[];

      for(const r of rows){
        const ent = {
          nom: r[COLS.ent_name],
          adresse: r[COLS.ent_addr],
          cp: r[COLS.ent_cp],
          ville: r[COLS.ent_ville],
          description: r[COLS.ent_desc],
          parcours: parseParcours(r[COLS.parcours]),
          personnes:[]
        };
        // 3 personnes
        for(const base of ["p1","p2","p3"]){
          const nom = r[COLS[base+"_nom"]];
          const prenom = r[COLS[base+"_prenom"]];
          if(nom && prenom){
            const poste = r[COLS[base+"_poste"]];
            const dej   = r[COLS[base+"_dej"]];
            ent.personnes.push({nom, prenom, poste, dejeuner: dej});
            totalPeople++;
            if(isOui(dej)) lunchYes++;
          }
        }
        companies.push(ent);
        for(const p of ent.parcours){
          companiesPerParcours[p]++; 
          peoplePerParcours[p]+=ent.personnes.length;
          groups[p].push(ent);
        }
      }
      return {totalPeople,lunchYes,totalCompanies:companies.length,peoplePerParcours,companiesPerParcours,groups,companies};
    }

    function renderKPIs(t){
      el('#k_total_people').textContent = fmt(t.totalPeople);
      el('#k_lunch_yes').textContent = fmt(t.lunchYes);
      el('#k_total_companies').textContent = fmt(t.totalCompanies);
      el('#k_aii_people').textContent = fmt(t.peoplePerParcours.AII);
      el('#k_ese_people').textContent = fmt(t.peoplePerParcours.ESE);
      el('#k_eme_people').textContent = fmt(t.peoplePerParcours.EME);
      el('#k_aii_companies').textContent = fmt(t.companiesPerParcours.AII);
      el('#k_ese_companies').textContent = fmt(t.companiesPerParcours.ESE);
      el('#k_eme_companies').textContent = fmt(t.companiesPerParcours.EME);
    }

    function createGroup(title, list){
      const details = document.createElement('details');
      details.className = 'group';
      details.open = true;
      const summary = document.createElement('summary');
      summary.innerHTML = `<span>${title}</span><span class="pill mono">${fmt(list.length)} entreprise${list.length>1?'s':''}</span>`;
      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Entreprise</th>
            <th>Ville</th>
            <th>Code postal</th>
            <th>Adresse</th>
            <th>Description</th>
            <th>Personnes (déclarées)</th>
            <th>Parcours</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      for(const ent of list){
        const tr = document.createElement('tr');
        const parcoursBadges = Array.from(ent.parcours).map(p=>`<span class="chip chip-${p.toLowerCase()}"><span class="chip-dot"></span>${p}</span>`).join(' ');
        tr.innerHTML = `
          <td><strong>${ent.nom||'—'}</strong></td>
          <td>${ent.ville||'—'}</td>
          <td class="mono">${ent.cp||'—'}</td>
          <td>${ent.adresse||'—'}</td>
          <td style="white-space:pre-wrap">${ent.description||'—'}</td>
          <td class="mono">${ent.nb_declares||0}</td>
          <td>${parcoursBadges||'—'}</td>`;
        tbody.appendChild(tr);
      }
      wrap.appendChild(table);
      details.appendChild(summary);
      details.appendChild(wrap);
      return details;
    }

    function renderGroups(t){
      const host = el('#groups');
      host.innerHTML = '';
      host.appendChild(createGroup('AII', t.groups.AII));
      host.appendChild(createGroup('ESE', t.groups.ESE));
      host.appendChild(createGroup('EME', t.groups.EME));
    }

    const btnExport = el('#btnExport');
    const btnExportFull = el('#btnExportFull');
    let lastTotals = null;

    function boot(){
      try{
        const rows = Array.isArray(SERVER_DATA) ? SERVER_DATA : [];
        const totals = processData(rows);
        if(!totals) throw new Error('Aucune donnée trouvée');
        lastTotals = totals;
        renderKPIs(totals);
        renderGroups(totals);
        btnExport.disabled = false;
        btnExportFull.disabled = false;
      }catch(err){
        console.error(err);
        alert('Erreur de traitement des données: '+ err.message);
        btnExport.disabled = true;
      }
    }

    function buildPeopleCSV(companies){
      const rows = [["Nom","Prénom","Poste","Entreprise"]];
      for(const ent of companies){
        for(const p of ent.personnes){ rows.push([p.nom,p.prenom,p.poste,ent.nom].map(v=>v==null?"":String(v))); }
      }
      const csv = rows.map(r=>r.map(c=>{ const s=String(c); return /[";,\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(';')).join('\n');
      return csv;
    }
    function triggerDownload(filename, content){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    btnExport.addEventListener('click', ()=>{
      if(!lastTotals) return;
      const csv = buildPeopleCSV(lastTotals.companies);
      triggerDownload('personnes_export.csv', csv);
    });
    // Normalise et échappe une cellule
    // Normalise et échappe une cellule
const cell = v => {
  const s = (v == null ? "" : String(v)).normalize("NFC");
  return /[";\n\r]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
};

// Construit le CSV (séparateur ;, ligne "sep=;", CRLF)
const csvString = rows => [
  "sep=;",
  ...rows.map(r => r.map(cell).join(";"))
].join("\r\n");

// Déclenche le téléchargement avec BOM UTF-8
function downloadCSV(filename, rows){
  const csv = csvString(rows);
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:filename });
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

// Exemple d’usage avec vos données SERVER_DATA
function exportPeopleFull(){
  const rows = [["Nom","Prénom","Poste","Email","Entreprise","Déj"]];
  for(const r of (Array.isArray(SERVER_DATA)? SERVER_DATA : [])){
    const ent = (r[COLS.ent_name] ?? "").toString();
    for(const base of ["p1","p2","p3"]){
      const nom    = r[COLS[base+"_nom"]];
      const prenom = r[COLS[base+"_prenom"]];
      if(!nom || !prenom) continue;
      rows.push([
        nom, prenom,
        r[COLS[base+"_poste"]],
        r[COLS[base+"_email"]],
        ent,
        r[COLS[base+"_dej"]]
      ]);
    }
  }
  downloadCSV("personnes_complet.csv", rows);
}

// Brancher sur votre bouton
btnExportFull.addEventListener("click", exportPeopleFull);

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
