<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>[GEII] Forum des metiers</title>
<style>
  :root{
    --blue:#009de0;
    --ink:#1a1a1a;
    --bg:#ffffff;
    --brown:#443a31;
    --radius:18px;
    --error:#b00020;
    --chip:#eef7ff;
  }
  /* ===== ENTÊTE style "UBx GEII" (original) ===== */
  .ubx-header{border-bottom:1px solid #e6e6e6;background:#fff}
  .ubx-container{max-width:95%;margin:0 auto;padding:0 16px}

  .ubx-utility{background:var(--blue);font-size:13px}
  .ubx-utility .ubx-container{display:flex;justify-content:flex-end;gap:14px;height:37px}
  .ubx-utility a{color:#111;text-decoration:none}
  .ubx-utility a:focus,.ubx-utility a:hover{text-decoration:underline}

  .ubx-bar{border-top:1px solid #e6e6e6; position:sticky; top:0; z-index:1000; background:#fff;}
  .ubx-bar .ubx-container{display:flex;align-items:center;justify-content:space-between;height:122px;gap:16px}
  .ubx-brand{display:flex;align-items:center;gap:14px;min-width:0}
  .ubx-logo{height:60px;border-radius:6px;background:url("/geii/forum-metier/static/ressources/GEII_logo_60px.png'") center/contain no-repeat;flex:0 0 404px}
  .ubx-site{display:flex;flex-direction:column;white-space:nowrap;overflow:hidden}
  .ubx-site .ubx-line1{font-size:12px;letter-spacing:.04em;color:#666;text-transform:uppercase}
  .ubx-site .ubx-line2{font-size:18px;font-weight:700;line-height:1.1}
  .ubx-site .ubx-line3{font-size:12px;color:#666}

  #ubx-menu-toggle{display:none}
  .ubx-burger{display:none;width:40px;height:40px;border:1px solid #ddd;border-radius:8px;align-items:center;justify-content:center;cursor:pointer}
  .ubx-burger span{display:block;width:20px;height:2px;background:#111;position:relative}
  .ubx-burger span::before,.ubx-burger span::after{content:"";position:absolute;left:0;width:20px;height:2px;background:#111}
  .ubx-burger span::before{top:-6px}.ubx-burger span::after{top:6px}

  nav.ubx-nav{position:relative}
  .ubx-menu{list-style:none;margin:0;padding:0;display:flex;gap:22px;align-items:center}
  .ubx-menu>li{position:relative}
  .ubx-menu a,.ubx-menu button{font-size:15px;color:#111;text-decoration:none;background:none;border:0;padding:8px 2px;cursor:pointer}
  .ubx-menu a:hover,.ubx-menu a:focus,.ubx-menu button:hover,.ubx-menu button:focus{outline:none;text-decoration:underline}

  .ubx-sub{position:absolute;left:0;top:100%;min-width:240px;background:#fff;border:1px solid #e6e6e6;box-shadow:0 10px 24px rgba(0,0,0,.08);border-radius:10px;padding:8px 0;display:none;z-index:10}
  .ubx-sub li{list-style:none}
  .ubx-sub a{display:block;padding:10px 14px;text-decoration:none;color:#111;white-space:normal}
  .ubx-sub a:hover{background:#f5f5f5;text-decoration:none}
  .has-sub:hover>.ubx-sub,.has-sub:focus-within>.ubx-sub{display:block}

  .ubx-exp-toggle{display:none}
  .ubx-exp{display:none;margin-left:6px;font-size:13px;color:#666;cursor:pointer}
  .ubx-exp::after{content:"▾"}
  .has-sub .ubx-exp-toggle:checked ~ .ubx-sub{display:block}

  .ubx-titleband{background:#eee;border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6}
  .ubx-titleband .ubx-container{padding:16px}
  .ubx-titleband h1{margin:0;font-size:28px;font-weight:700}

  /* Adresse / CP / Ville */
  .row.addr-line .col-50{flex:0 0 50%}
  .row.addr-line .col-25{flex:0 0 20%}
  @media (max-width:720px){
    .row.addr-line .col-50,.row.addr-line .col-25{flex-basis:100%}
  }

  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#f7f7f7;}
  .wrap{max-width:1000px; margin:20px auto 40px; padding:0 16px}
  .card{background:var(--bg); border:1px solid #000; border-radius:var(--radius); box-shadow:0 6px 28px rgba(0,0,0,.08); overflow:hidden;}
  .card-head{border-bottom:1px solid #000; padding:18px; display:flex; align-items:center; justify-content:center;}
  .card-head h2{margin:0; font-family:"Agency FB", Arial, sans-serif; font-size:28px; letter-spacing:.5px}

  form{display:flex; flex-direction:column; gap:24px; padding:20px}
  form .error-summary{border-left:4px solid var(--error); background:#ffeef1; color:#400; padding:12px 14px; border-radius:8px; display:none;}
  .field-error{color:var(--error); font-size:12px; display:none;}
  .row{display:flex; flex-wrap:wrap; gap:16px}
  .col{display:flex; flex-direction:column; gap:6px; min-width:220px; flex:1}
  label{font-size:14px}
  input[type="text"], input[type="email"], textarea{
    border:2px solid var(--blue); border-radius:8px; padding:10px 12px; background:#fff;
    font-size:14px; color:var(--ink);
  }
  textarea{min-height:110px; resize:vertical}

  .checks,.radios{display:flex; gap:22px; align-items:center; flex-wrap:wrap}
  .radio{display:flex; align-items:center; gap:8px; min-width:60px}
  .radio input{appearance:none;width:25px;height:25px;border:2px solid var(--blue);border-radius:50%;background:#fff;background-repeat:no-repeat;background-position:center;background-size:0 0;cursor:pointer}
  .radio input:checked{background-image:radial-gradient(var(--brown) 0,var(--brown) 60%,transparent 75%);background-size:70% 70%}

  /* Participants */
  .participants{border:1px solid #000; border-radius:20px; padding:16px; background:#fff;}
  .participant-panel{padding:14px; border:1px dashed #ccc; border-radius:14px; margin-top:10px}
  .participant-title{font-weight:700; margin:0 0 8px 0}
  .participant-panel .two{display:flex; gap:16px}
  .participant-panel .two .col{flex:1}
  @media (max-width:720px){ .participant-panel .two{flex-direction:column} }

  .actions{display:flex; justify-content:center}
  .btn{border:2px solid #000; background:var(--blue); color:#fff; border-radius:28px; padding:14px 22px; cursor:pointer; line-height:1; letter-spacing:.06em; font-size:24px;}
  .link-chip{display:inline-block; background:var(--chip); padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #cfe8ff}

  /* Timeline */
  .timeline{position:relative; display:flex; justify-content:space-around; align-items:flex-start; gap:20px; margin:20px 0; padding:0px 10px 10px; flex-wrap:wrap; min-height:90px;}
  .timeline::before{content:""; position:absolute; top:30px; left:5%; right:5%; height:2px; background:var(--brown); z-index:0;}
  .timeline-item{flex:1; min-width:200px; text-align:center; position:relative; z-index:1;}
  .timeline-item::before{content:""; position:absolute; top:22px; left:50%; transform:translateX(-50%); width:16px; height:16px; border-radius:50%; background:var(--blue); border:2px solid var(--brown);}
  .timeline-item span{display:block;margin-top:40px;font-size:14px;font-weight:600}

  /* Review overlay */
  .review-overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:2000;}
  .review-card{background:#fff; color:#111; width:min(900px,95vw); max-height:90vh; overflow:auto; border-radius:16px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .review-card h3{margin:0 0 10px 0}
  .review-grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .review-row{border-bottom:1px solid #eee; padding:6px 0}
  .review-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
  .btn-secondary{background:#fff; color:#111; border:1px solid #aaa; border-radius:10px; padding:10px 14px; cursor:pointer}

  /* ===== Panneau global de suggestions (hors .card) ===== */
  .ville-suggest-aside{
    position:absolute; top:420px; right:35px; width:min(360px, 86vw);
    background:#fff; border:1px solid #cfe8ff; border-radius:12px;
    box-shadow:0 10px 32px rgba(0,0,0,.15); padding:10px; z-index:1500; display:none;
  }
  .ville-suggest-aside h4{margin:0 0 6px 0; font-size:14px; color:#0b2940}
  .ville-suggest-list{display:flex; flex-direction:column; gap:6px; max-height:55vh; overflow:auto}
  .ville-suggest-item{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid #e6f2ff; border-radius:8px; cursor:pointer; background:#f8fbff}
  .ville-suggest-item:hover{background:#eef7ff}
  .ville-suggest-city{font-weight:700}
  .ville-suggest-cp{font-size:12px; color:#444}
  .ville-suggest-actions{display:flex; justify-content:flex-end; margin-top:6px}
  .btn-close{background:#fff; border:1px solid #bbb; border-radius:8px; padding:6px 10px; cursor:pointer}
  @media (max-width:720px){
    .ville-suggest-aside{top:auto; bottom:18px; right:18px}
  }
</style>
</head>
<body>
  <header class="ubx-header" role="banner">
    <div class="ubx-utility">
      <div class="ubx-container">
        <a href="https://www.facebook.com/iut.geii.bordeaux" aria-label="Facebook">Facebook</a>
        <a href="https://www.youtube.com/user/iutgeiibordeaux" aria-label="YouTube">YouTube</a>
        <a href="https://www.linkedin.com/school/iut-geii-bordeaux/" aria-label="LinkedIn">LinkedIn</a>
      </div>
    </div>

    <div class="ubx-bar">
      <div class="ubx-container">
        <div class="ubx-brand">
          <div class="ubx-logo" aria-hidden="true"></div>
        </div>

        <label for="ubx-menu-toggle" class="ubx-burger" aria-label="Ouvrir le menu">
          <span></span>
        </label>
        <input type="checkbox" id="ubx-menu-toggle" aria-hidden="true" />

        <nav class="ubx-nav" aria-label="Navigation principale">
          <ul class="ubx-menu">
            <li><a href="https://www.iut.u-bordeaux.fr/geii/geii-en-5-questions/">GEII en 5 questions</a></li>
            <li class="has-sub">
              <button type="button" aria-haspopup="true" aria-expanded="false">Le Département</button>
              <input class="ubx-exp-toggle" type="checkbox" id="exp-dept">
              <label class="ubx-exp" for="exp-dept" aria-label="Sous-menu Département"></label>
              <ul class="ubx-sub" aria-label="Sous-menu Département">
                <li><a href="https://www.iut.u-bordeaux.fr/geii/departement/">Présentation</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/actualites/">Actualités</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/projets/">Nos projets</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/geii-candidate-au-programme-ariss/">GEII et ARISS</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/contact/">Contact</a></li>
              </ul>
            </li>

            <li class="has-sub">
              <button type="button" aria-haspopup="true" aria-expanded="false">Le BUT</button>
              <input class="ubx-exp-toggle" type="checkbox" id="exp-but">
              <label class="ubx-exp" for="exp-but" aria-label="Sous-menu BUT"></label>
              <ul class="ubx-sub" aria-label="Sous-menu BUT">
                <li><a href="https://www.iut.u-bordeaux.fr/geii/but/">Le BUT</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/but-parcours-aii">Parcours AII</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/but-parcours-eme">Parcours EME</a></li>
                <li><a href="https://www.iut.u-bordeaux.fr/geii/but-parcours-ese">Parcours ESE</a></li>
              </ul>
            </li>

            <li><a href="https://www.iut.u-bordeaux.fr/geii/parcoursup/">Parcoursup</a></li>
            <li><a href="https://www.iut.u-bordeaux.fr/geii/cote-entreprise/">Côté entreprises</a></li>
            <li><a href="https://www.iut.u-bordeaux.fr/geii/cote-etudiants/">Côté étudiants</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>


  <main class="wrap">
    <section class="card">
      <div class="timeline">
        <div class="timeline-item">
          <span>Ouverture des pré-inscriptions : 8 octobre 2025</span>
        </div>
        <div class="timeline-item">
          <span>Clôture des pré-inscriptions : 28 novembre 2025</span>
        </div>
        <div class="timeline-item">
          <span>Retour sur les demandes de participation : au plus tard le 8 décembre 2025</span>
        </div>
      </div>

      <form id="inscription-form" action="/geii/forum-metier/validate" method="post" accept-charset="UTF-8" novalidate>
        <div class="error-summary" id="error-summary" role="alert" aria-live="assertive"></div>

        <div class="row">
          <div class="col">
            <label for="entreprise_nom">Nom de l'Entreprise</label>
            <input id="entreprise_nom" name="entreprise_nom" type="text" class="only-alnum-space" required pattern="^[A-Za-zÀ-ÖØ-öø-ÿ0-9 ]+$" />
            <small class="field-error" data-for="entreprise_nom"></small>
          </div>
        </div>
        <div class="row addr-line">
          <div class="col col-50">
            <label for="entreprise_adresse">Adresse de l'Entreprise</label>
            <input id="entreprise_adresse" name="entreprise_adresse" type="text" class="only-alnum-space" required pattern="^[A-Za-zÀ-ÖØ-öø-ÿ0-9 ]+$" />
            <small class="field-error" data-for="entreprise_adresse"></small>
          </div>
          <div class="col col-25">
            <label for="code_postal">Code postal</label>
            <input id="code_postal" name="code_postal" type="text" inputmode="numeric" maxlength="5" placeholder="ex: 33000" required/>
            <small class="field-error" data-for="code_postal"></small>
          </div>
          <div class="col col-25">
            <label for="ville">Ville</label>
            <input id="ville" name="ville" type="text" required autocomplete="off"/>
            <small class="field-error" data-for="ville"></small>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="entreprise_description">Décrivez brièvement votre entreprise (750 caractères maximum).</label>
            <textarea id="entreprise_description" name="entreprise_description" maxlength="750" style="height:145px;resize:none"></textarea>
          </div>
        </div>

        <div class="row" style="justify-content:center">
          <label class="col" style="flex:0 0 100%; text-align:center">
            Quels parcours du BUT GEII représentez-vous ?<br>(Plusieurs réponses possibles – cochez les parcours concernés)
          </label>
          <div class="checks" aria-label="Parcours BUT GEII">
            <label class="radio">
              <input id="parcours_aii" name="parcours_but" type="checkbox" value="AII" />
              <span>AII</span>
              <a class="link-chip" href="https://www.iut.u-bordeaux.fr/geii/but-parcours-aii/" target="_blank" rel="noopener">Page AII</a>
            </label>
            <label class="radio">
              <input id="parcours_eme" name="parcours_but" type="checkbox" value="EME" />
              <span>EME</span>
              <a class="link-chip" href="https://www.iut.u-bordeaux.fr/geii/but-parcours-eme/" target="_blank" rel="noopener">Page EME</a>
            </label>
            <label class="radio">
              <input id="parcours_ese" name="parcours_but" type="checkbox" value="ESE" />
              <span>ESE</span>
              <a class="link-chip" href="https://www.iut.u-bordeaux.fr/geii/but-parcours-ese/" target="_blank" rel="noopener">Page ESE</a>
            </label>
          </div>
        </div>

        <div class="row" style="justify-content:center">
          <label class="col" style="flex:0 0 100%; text-align:center">Combien de personnes de votre entreprise seront présentes au job dating ?</label>
          <div class="radios" role="radiogroup" aria-label="Nombre de personnes">
            <label class="radio"><input id="nb_1" name="nb_personnes" type="radio" value="1" checked/> <span>1</span></label>
            <label class="radio"><input id="nb_2" name="nb_personnes" type="radio" value="2" /> <span>2</span></label>
            <label class="radio"><input id="nb_3" name="nb_personnes" type="radio" value="3" /> <span>3</span></label>
          </div>
        </div>

        <section class="participants" id="participants">
          <div id="participant-panels"></div>

          <template id="participant-template">
            <div class="participant-panel">
              <h4 class="participant-title">Participant __i__</h4>
              <div class="two">
                <div class="col">
                  <label for="participant_nom__i__">Nom</label>
                  <input id="participant_nom__i__" name="participants[__i__][nom]" type="text" required class="only-letters" pattern="^[A-Za-zÀ-ÖØ-öø-ÿ]+$"/>
                  <small class="field-error" data-for="participants[__i__][nom]"></small>
                </div>
                <div class="col">
                  <label for="participant_prenom__i__">Prénom</label>
                  <input id="participant_prenom__i__" name="participants[__i__][prenom]" type="text" required class="only-letters" pattern="^[A-Za-zÀ-ÖØ-öø-ÿ]+$"/>
                  <small class="field-error" data-for="participants[__i__][prenom]"></small>
                </div>
              </div>

              <div class="row">
                <div class="col">
                  <label for="participant_email__i__">Adresse mail</label>
                  <input id="participant_email__i__" class="check-email" name="participants[__i__][email]" type="email" inputmode="email" autocomplete="email" required pattern="^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$"/>
                  <small class="field-error" data-for="participants[__i__][email]"></small>
                </div>
                <div class="col" style="max-width:320px">
                  <label for="participant_poste__i__">Poste actuel</label>
                  <input id="participant_poste__i__" name="participants[__i__][poste]" type="text" required class="only-letters" pattern="^[A-Za-zÀ-ÖØ-öø-ÿ]+$"/>
                  <small class="field-error" data-for="participants[__i__][poste]"></small>
                </div>
              </div>

              <div class="row" style="justify-content:center">
                <label class="col" style="flex:0 0 100%; text-align:center; margin-top:6px">
                  Participera-t-il/elle au déjeuner le vendredi de 12h30 à 13h30 ?
                </label>
                <div class="radios" role="radiogroup" aria-label="Déjeuner vendredi">
                  <label class="radio"><input id="dej_oui__i__" name="participants[__i__][dej_vendredi]" type="radio" value="OUI" required checked/> <span>Oui</span></label>
                  <label class="radio"><input id="dej_non__i__" name="participants[__i__][dej_vendredi]" type="radio" value="NON" required/> <span>Non</span></label>
                </div>
              </div>
            </div>
          </template>
        </section>

        <div class="actions">
          <button class="btn" id="btn-review" type="button">VALIDER</button>
        </div>
      </form>
    </section>

    <!-- ===== Panneau global de suggestions (HORS .card) ===== -->
    <aside class="ville-suggest-aside" id="ville-suggest" aria-live="polite" aria-label="Suggestions de communes">
      <h4>Suggestions de communes</h4>
      <div class="ville-suggest-list" id="ville-suggest-list"></div>
      <div class="ville-suggest-actions">
        <button type="button" class="btn-close" id="ville-suggest-close">Fermer</button>
      </div>
    </aside>
  </main>

  <div class="review-overlay" id="review">
    <div class="review-card" role="dialog" aria-modal="true" aria-labelledby="review-title">
      <h3 id="review-title">Vérifiez vos informations</h3>
      <div id="review-content"></div>
      <div class="review-actions">
        <button type="button" class="btn-secondary" id="btn-edit">Modifier</button>
        <button type="button" class="btn" id="btn-submit">Valider</button>
      </div>
    </div>
  </div>

<footer class="geii-footer" role="contentinfo">
  <style>
    .geii-footer{width:100%;background:var(--blue);color:#eef0f2;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; border-top:1px solid #2b2f36;}
    .geii-footer a{color:#eef0f2;text-decoration:none}
    .geii-footer a:focus,.geii-footer a:hover{text-decoration:underline}
    .geii-footer .wrap{max-width:1200px;margin:0 auto;padding:40px 20px}
    .geii-footer .cols{display:flex;gap:48px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .geii-footer h4{margin:0 0 12px 0;font-size:16px;letter-spacing:.2px;color:#ffffff}
    .geii-footer .col{flex:1 1 260px;min-width:260px}
    .geii-footer address{font-style:normal;white-space:pre-line;color:#cdd3d8}
    .geii-footer ul{list-style:none;margin:0;padding:0}
    .geii-footer li{margin:6px 0}
    .geii-footer .bottom{background:var(--brown); border-top:1px solid #2b2f36; margin-top:28px; padding:16px 20px; color:#fff; display:flex; gap:0%; align-items:center; justify-content:center; flex-wrap:wrap; max-width:100%}
    .bottom > a:nth-child(2) { margin-left:4px }
    .geii-footer .brand{display:inline-flex;align-items:center;gap:10px}
    .geii-footer .brand img{height:28px;width:auto;display:block;background:url(iut_bx_tr_footer.png)}
    @media (max-width:800px){
      .geii-footer .cols{gap:28px}
      .geii-footer .col{flex:1 1 100%}
    }
  </style>

  <div class="wrap">
    <div class="cols">
      <section class="col">
        <h4>Dept GEII Bordeaux</h4>
        <address>
15 rue Naudet
CS&nbsp;10207
33175&nbsp;Gradignan&nbsp;Cedex

Tél&nbsp;: 05&nbsp;56&nbsp;84&nbsp;57&nbsp;58&nbsp;(ou&nbsp;59)
Fax&nbsp;: 05&nbsp;56&nbsp;84&nbsp;57&nbsp;83
        </address>
      </section>

      <section class="col">
        <h4>Articles récents</h4>
        <ul id="geii-recent-posts">
          <li>Chargement…</li>
        </ul>
      </section>

      <nav class="col links" aria-label="Liens utiles">
        <h4>Liens</h4>
        <ul>
          <li><a href="https://intranet.iut.u-bordeaux.fr" rel="noopener">Intranet IUT de Bordeaux</a></li>
          <li><a href="https://moodle1.u-bordeaux.fr" rel="noopener">Moodle GEII Bordeaux</a></li>
          <li><a href="https://www.iutenligne.net" rel="noopener">IUT en ligne</a></li>
          <li><a href="https://www.u-bordeaux.fr" rel="noopener">Université de Bordeaux</a></li>
        </ul>
      </nav>
      <img class="col" src="{{url_for('static', filename='ressources/iut_bx_tr_footer.png')}}" alt="IUT de Bordeaux - GEII">
    </div>
  </div>
  <div class="bottom">
      <div class="brand">
        <span>© 2014 - Département GEII / IUT de Bordeaux |</span>
      </div>
      <a href="https://www.iut.u-bordeaux.fr/geii/mentions-legales" rel="noopener">Mentions légales</a>
  </div>
  <script>
    (function(){
      const list = document.getElementById('geii-recent-posts');
      const endpoint = 'https://www.iut.u-bordeaux.fr/geii/wp-json/wp/v2/posts?per_page=5&_fields=link,title.rendered';
      fetch(endpoint, {mode:'cors'})
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(posts => {
          list.innerHTML = '';
          posts.forEach(p => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = p.link;
            a.innerHTML = p.title.rendered;
            li.appendChild(a);
            list.appendChild(li);
          });
          if(!posts.length){ list.innerHTML = '<li>Aucun article</li>'; }
        })
        .catch(() => { list.innerHTML = '<li>Impossible de charger les articles.</li>'; });
    })();
  </script>
</footer>

<!-- JS principal -->
<script>
(function(){
  const form = document.getElementById('inscription-form');
  const errorSummary = document.getElementById('error-summary');
  const panelsWrap = document.getElementById('participant-panels');
  const tpl = document.getElementById('participant-template').content;
  const review = document.getElementById('review');
  const reviewContent = document.getElementById('review-content');
  const btnReview = document.getElementById('btn-review');
  const btnEdit = document.getElementById('btn-edit');
  const btnSubmit = document.getElementById('btn-submit');

  function makePanel(i){
    const clone = document.importNode(tpl, true);
    clone.querySelectorAll('[id]').forEach(el=>{ el.id = el.id.replace(/__i__/g, i); });
    clone.querySelectorAll('[name]').forEach(el=>{ el.name = el.name.replace(/__i__/g, i); });
    clone.querySelector('.participant-title').textContent = 'Participant ' + i;
    return clone;
  }
  function getCount(){
    const checked = document.querySelector('input[name="nb_personnes"]:checked');
    return checked ? parseInt(checked.value,10) : 1;
  }
  function snapshotPanels(){
    return Array.from(panelsWrap.querySelectorAll('.participant-panel')).map(panel=>{
      const data = {};
      panel.querySelectorAll('input').forEach(inp=>{
        if(inp.type==='radio'){ if(inp.checked) data[inp.name]=inp.value; }
        else data[inp.name]=inp.value;
      });
      return data;
    });
  }
  function render(count){
    const snap = snapshotPanels();
    panelsWrap.innerHTML = '';
    for(let i=1;i<=count;i++){ panelsWrap.appendChild(makePanel(i)); }
    const newPanels = panelsWrap.querySelectorAll('.participant-panel');
    snap.slice(0, newPanels.length).forEach((data, idx)=>{
      Object.entries(data).forEach(([name,val])=>{
        const el = newPanels[idx].querySelector(`[name="${CSS.escape(name)}"]`);
        if(!el) return;
        if(el.type==='radio'){
          const r = newPanels[idx].querySelector(`[name="${CSS.escape(name)}"][value="${CSS.escape(val)}"]`);
          if(r) r.checked = true;
        }else{ el.value = val; }
      });
    });
  }
  render(getCount());
  document.querySelectorAll('input[name="nb_personnes"]').forEach(r=>{
    r.addEventListener('change', ()=>render(getCount()));
  });

  /* ===== Auto-ville + suggestions (panneau global) ===== */
  const cp = document.getElementById('code_postal');
  const ville = document.getElementById('ville');
  const suggestBox = document.getElementById('ville-suggest');
  const suggestList = document.getElementById('ville-suggest-list');
  const suggestClose = document.getElementById('ville-suggest-close');

  function openSuggest(){ suggestBox.style.display='block'; }
  function closeSuggest(){ suggestBox.style.display='none'; }
  suggestClose.addEventListener('click', closeSuggest);

  function showSuggestions(items){
    suggestList.innerHTML = '';
    if(!items || !items.length){ closeSuggest(); return; }
    items.slice(0,5).forEach(item=>{
      const div = document.createElement('div');
      div.className = 'ville-suggest-item';
      const city = document.createElement('span');
      city.className='ville-suggest-city';
      city.textContent = item.nom;
      const cps = document.createElement('span');
      cps.className='ville-suggest-cp';
      cps.textContent = Array.isArray(item.codesPostaux) ? item.codesPostaux.join(' · ') : (item.codePostal || '');
      div.appendChild(city); div.appendChild(cps);
      div.addEventListener('click', ()=>{
        ville.value = item.nom;
        const currentCp = cp.value.trim();
        let chosen = '';
        if(Array.isArray(item.codesPostaux)){
          chosen = item.codesPostaux.includes(currentCp) ? currentCp : item.codesPostaux[0];
        }else{
          chosen = item.codePostal || currentCp;
        }
        if(/^\d{5}$/.test(chosen)) cp.value = chosen;
        closeSuggest();
        setFieldError('ville','');
        setFieldError('code_postal','');
      });
      suggestList.appendChild(div);
    });
    openSuggest();
  }
  function debounce(fn,ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
  }
  async function fetchByCP(code){
    try{
      const resp = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${encodeURIComponent(code)}&fields=nom,codesPostaux&format=json`);
      if(!resp.ok) return [];
      return await resp.json();
    }catch{ return []; }
  }
  async function fetchByCityName(q){
    try{
      const resp = await fetch(`https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(q)}&fields=nom,codesPostaux&boost=population&limit=5`);
      if(!resp.ok) return [];
      return await resp.json();
    }catch{ return []; }
  }
  const updateByCP = debounce(async ()=>{
    const v = cp.value.replace(/\D/g,'');
    if(v.length!==5){ closeSuggest(); return; }
    const list = await fetchByCP(v);
    showSuggestions(list);
  }, 250);
  const updateByCity = debounce(async ()=>{
    const q = ville.value.trim();
    if(q.length<2){ closeSuggest(); return; }
    const list = await fetchByCityName(q);
    showSuggestions(list);
  }, 250);

  cp.addEventListener('input', ()=>{
    const v = cp.value.replace(/\D/g,'').slice(0,5);
    if(cp.value!==v) cp.value=v;
    updateByCP();
  });
  ville.addEventListener('input', updateByCity);

  document.addEventListener('click', (e)=>{
    const inside = suggestBox.contains(e.target) || e.target===ville || e.target===cp;
    if(!inside) closeSuggest();
  });

  /* ===== Erreurs + validation ===== */
  function setFieldError(name, msg){
    const small = form.querySelector(`.field-error[data-for="${CSS.escape(name)}"]`);
    if(small){
      small.textContent = msg || '';
      small.style.display = msg ? 'block' : 'none';
    }
  }
  function clearAllFieldErrors(){
    form.querySelectorAll('.field-error').forEach(s=>{ s.textContent=''; s.style.display='none'; });
    errorSummary.style.display='none';
    errorSummary.textContent='';
  }
  function validate(){
    clearAllFieldErrors();
    const missing = [];
    function req(id, label){
      const el = document.getElementById(id);
      if(el && !el.value.trim()){
        setFieldError(el.name || id, 'Champ requis');
        missing.push(label);
      }
    }
    req('entreprise_nom', 'Nom de l’entreprise');
    req('entreprise_adresse', 'Adresse de l’entreprise');

    const vcp = cp.value.trim();
    if(!/^\d{5}$/.test(vcp)){
      setFieldError('code_postal', 'Code postal à 5 chiffres');
      missing.push('Code postal');
    }
    if(!ville.value.trim()){
      setFieldError('ville', 'Ville requise');
      missing.push('Ville');
    }
    if (!document.querySelectorAll('input[name="parcours_but"]:checked').length > 0) {
      missing.push("Parcours");
    }

    const count = getCount();
    for(let i=1;i<=count;i++){
      const fields = [
        {sel:`participants[${i}][nom]`, label:`Participant ${i} : Nom`},
        {sel:`participants[${i}][prenom]`, label:`Participant ${i} : Prénom`},
        {sel:`participants[${i}][email]`, label:`Participant ${i} : Email`},
        {sel:`participants[${i}][poste]`, label:`Participant ${i} : Poste`},
      ];
      fields.forEach(f=>{
        const el = form.querySelector(`[name="${CSS.escape(f.sel)}"]`);
        if(el && !el.value.trim()){
          setFieldError(f.sel, 'Champ requis');
          missing.push(f.label);
        }
      });
    }

    if(missing.length){
      errorSummary.innerHTML = '<strong>Veuillez compléter les champs suivants :</strong><br>' + missing.map(m=>'- '+m).join('<br>');
      errorSummary.style.display='block';
      errorSummary.setAttribute('tabindex','-1');
      errorSummary.focus();
      errorSummary.scrollIntoView({behavior:'smooth', block:'start'});
      return false;
    }
    return true;
  }

  function buildReview(){
    const data = new FormData(form);
    const count = getCount();
    function row(k, v){
      return `<div class="review-row"><strong>${k}</strong><div>${v ? String(v).replace(/</g,'&lt;') : ''}</div></div>`;
    }
    let html = '<div class="review-grid">';
    html += row("Entreprise", data.get('entreprise_nom'));
    html += row("Adresse", data.get('entreprise_adresse'));
    html += row("Code postal", data.get('code_postal'));
    html += row("Ville", data.get('ville'));
    html += row("Description", data.get('entreprise_description'));
    const parcours = Array.from(document.querySelectorAll('input[name="parcours_but"]:checked')).map(i=>i.value).join(', ');
    html += row("Parcours", parcours || 'Aucun');
    html += row("Nombre de participants", String(count));
    html += '</div>';
    for(let i=1;i<=count;i++){
      html += `<h4 style="margin-top:10px">Participant ${i}</h4><div class="review-grid">`;
      html += row("Nom", data.get(`participants[${i}][nom]`));
      html += row("Prénom", data.get(`participants[${i}][prenom]`));
      html += row("Email", data.get(`participants[${i}][email]`));
      html += row("Poste", data.get(`participants[${i}][poste]`));
      html += row("Déjeuner vendredi", data.get(`participants[${i}][dej_vendredi]`));
      html += '</div>';
    }
    reviewContent.innerHTML = html;
  }

  btnReview.addEventListener('click', ()=>{
    if(!validate()) return;
    buildReview();
    review.style.display='flex';
  });
  btnEdit.addEventListener('click', ()=>{ review.style.display='none'; });
  btnSubmit.addEventListener('click', ()=>{
    review.style.display='none';
    form.submit();
  });
})();
</script>

<!-- Filtres entrées: lettres-only pour participants + emails -->
<script>
(() => {
  const stripNonLetters = s => s.normalize('NFC').replace(/[^\p{L}]+/gu, "");
  document.addEventListener('beforeinput', (e) => {
    if (!e.target.matches('.only-letters')) return;
    if (e.inputType.startsWith('insert') && e.data && /[^\p{L}]/u.test(e.data)) e.preventDefault();
  });
  document.querySelectorAll('.only-letters').forEach((el) => {
    el.addEventListener('paste', (e) => {
      const t = (e.clipboardData || window.clipboardData).getData('text');
      const cleaned = stripNonLetters(t);
      if (cleaned !== t) {
        e.preventDefault();
        const { selectionStart:s, selectionEnd:eEnd } = el;
        el.setRangeText(cleaned, s, eEnd, 'end');
      }
    });
    el.addEventListener('input', () => {
      const v = el.value, c = stripNonLetters(v);
      if (v !== c) {
        const d = v.length - c.length;
        el.value = c;
        if (el.setSelectionRange) {
          const p = Math.max((el.selectionStart||c.length) - d, 0);
          el.setSelectionRange(p, p);
        }
      }
    });
  });
  const form = document.querySelector('form');
  if (form) form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) { e.preventDefault(); form.reportValidity(); }
  });
})();

(() => {
  document.addEventListener('input', (e) => {
    if (!e.target.matches('.check-email')) return;
    const v = e.target.value.replace(/\s+/g,'');
    if (e.target.value !== v) e.target.value = v;
  });
  function validateEmail(el){
    el.setCustomValidity('');
    if (el.validity.valueMissing) el.setCustomValidity('Adresse email requise');
    else if (el.validity.typeMismatch || el.validity.patternMismatch) el.setCustomValidity('Adresse email invalide (ex. nom@domaine.tld)');
  }
  document.querySelectorAll('.check-email').forEach(el => {
    ['blur','input','change'].forEach(ev => el.addEventListener(ev, () => {
      validateEmail(el);
      if (!el.checkValidity()) el.reportValidity();
    }));
  });
  const form = document.querySelector('form');
  if (form) form.addEventListener('submit', (e) => {
    let ok = true;
    form.querySelectorAll('.check-email').forEach(el => {
      validateEmail(el);
      ok = el.checkValidity() && ok;
    });
    if (!ok || !form.checkValidity()) { e.preventDefault(); form.reportValidity(); }
  });
})();
</script>
<script>
/* Autorise uniquement lettres FR, chiffres, espaces sur .only-alnum-space */
(() => {
  const re = /[^A-Za-z0-9À-ÖØ-öø-ÿ ]+/g;

  // bloque à la frappe des caractères interdits
  document.addEventListener('beforeinput', (e) => {
    if (!e.target.matches('.only-alnum-space')) return;
    if (e.inputType.startsWith('insert') && e.data && re.test(e.data)) e.preventDefault();
  });

  // nettoie le collage et toute entrée indirecte
  document.addEventListener('input', (e) => {
    if (!e.target.matches('.only-alnum-space')) return;
    const v = e.target.value;
    const c = v.replace(re, '');
    if (v !== c) {
      const pos = e.target.selectionStart || c.length;
      e.target.value = c;
      if (e.target.setSelectionRange) e.target.setSelectionRange(pos - (v.length - c.length), pos - (v.length - c.length));
    }
  });
})();
</script>
</body>
</html>
